"use strict";var shareImageButton=document.querySelector("#share-image-button");var createPostArea=document.querySelector("#create-post");var closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn");var sharedMomentsArea=document.querySelector("#shared-moments");var form=document.querySelector("form");var titleInput=document.querySelector("#title");var locationInput=document.querySelector("#location");var videoPlayer=document.querySelector("#player");var canvasElement=document.querySelector("#canvas");var imagePicker=document.querySelector("#image-picker");var imagePickerArea=document.querySelector("#pick-image");var captureButton=document.querySelector("#capture-btn");var locationBtn=document.querySelector("#location-btn");var locationLoader=document.querySelector("#location-loader");var picture;var fetchedLocation={lat:0,lng:0};locationBtn.addEventListener("click",function(e){if(!("geolocation"in navigator)){return}locationBtn.style.display="none";locationLoader.style.display="block";var t=false;navigator.geolocation.getCurrentPosition(function(e){locationBtn.style.display="inline";locationLoader.style.display="none";fetchedLocation={lat:e.coords.latitude,lng:0};locationInput.value="In Munich";document.querySelector("#manual-location").classList.add("is-focused")},function(e){console.log(e);locationBtn.style.display="inline";locationLoader.style.display="none";fetchedLocation={lat:0,lng:0};if(!t){alert("Couldn't fetch location, please enter manually.");t=true}},{timeout:7e3})});function initializeLocation(){if(!("geolocation"in navigator)){locationBtn.style.display="none"}}function initializeMedia(){if(!("mediaDevices"in navigator)){navigator.mediaDevices={}}if(!("getUserMedia"in navigator.mediaDevices)){navigator.mediaDevices.getUserMedia=function(a){var n=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;if(!n){return Promise.reject(new Error("getUserMedia is not implemented!"))}return new Promise(function(e,t){n.call(navigator,a,e,t)})}}navigator.mediaDevices.getUserMedia({video:true}).then(function(e){videoPlayer.srcObject=e;videoPlayer.style.display="block";imagePickerArea.style.display="none"}).catch(function(e){imagePickerArea.style.display="block"})}captureButton.addEventListener("click",function(e){canvasElement.style.display="block";videoPlayer.style.display="none";captureButton.style.display="none";var t=canvasElement.getContext("2d");t.drawImage(videoPlayer,0,0,canvasElement.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvasElement.width));videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()});picture=dataURItoBlob(canvasElement.toDataURL())});imagePicker.addEventListener("change",function(e){picture=e.target.files[0]});function openCreatePostModal(){setTimeout(function(){createPostArea.style.transform="translateY(0)"},1);initializeMedia();initializeLocation();if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then(function(e){if(e.outcome==="dismissed"){console.log("user cancelled installation")}else{console.log("added to home screen")}});deferredPrompt=null}}function closeCreatePostModal(){imagePickerArea.style.display="none";videoPlayer.style.display="none";canvasElement.style.display="none";locationBtn.style.display="inline";locationLoader.style.display="none";captureButton.style.display="inline";if(videoPlayer.srcObject){videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()})}setTimeout(function(){createPostArea.style.transform="translateY(100vh)"},1)}shareImageButton.addEventListener("click",openCreatePostModal);closeCreatePostModalButton.addEventListener("click",closeCreatePostModal);function onSaveButtonClicked(e){if("caches"in window){caches.open("user-requested").then(function(e){e.add("https://httpbin.org/get");e.add("/src/images/sf-boat.jpg")})}}function clearCards(){while(sharedMomentsArea.hasChildNodes()){sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)}}function updateUI(e){clearCards();for(var t=0;t<e.length;t++){createCard(e[t])}}function createCard(e){var t=document.createElement("div");t.className="shared-moment-card mdl-card mdl-shadow--2dp";var a=document.createElement("div");a.className="mdl-card__title";a.style.backgroundImage='url("'+e.image+'")';a.style.backgroundSize="cover";a.style.height="180px";t.appendChild(a);var n=document.createElement("h2");n.className="mdl-card__title-text";n.textContent=e.title;n.style.color="white";a.appendChild(n);var o=document.createElement("div");o.className="mdl-card__supporting-text";o.textContent=e.location;o.style.textAlign="center";t.appendChild(o);componentHandler.upgradeElement(t);sharedMomentsArea.appendChild(t)}var url="http://localhost:3000/api/posts";var networkDataReceived=false;fetch(url).then(function(e){return e.json()}).then(function(e){console.log("From web ",e);networkDataReceived=true;var t=[];for(var a in e){t.push(e[a])}updateUI(t)});function sendData(){var e="http://localhost:3000/api/posts";var t=(new Date).toISOString();var a=new FormData;a.append("title",titleInput.value);a.append("location",locationInput.value);a.append("rawLocationLat",fetchedLocation.lat);a.append("rawLocationLng",fetchedLocation.lng);a.append("file",picture,t+".png");fetch(e,{method:"POST",body:a}).then(function(e){console.log("Data sent to server",e);updateUI()})}if("indexedDB"in window){readAllData("posts").then(function(e){if(!networkDataReceived){console.log("From indexedDB ",e);updateUI(e)}})}form.addEventListener("submit",function(e){e.preventDefault();if(titleInput.value.trim()===""||locationInput.value.trim()===""){return}closeCreatePostModal();if("serviceWorker"in navigator&&"SyncManager"in window){navigator.serviceWorker.ready.then(function(e){var t={id:(new Date).toISOString(),title:titleInput.value,location:locationInput.value,rawLocation:fetchedLocation,picture:picture};writeData("sync-posts",t).then(function(){return e.sync.register("sync-new-posts")}).then(function(){var e=document.querySelector("#confirmation-toast");var t={message:"Your post saved for syncing"};e.MaterialSnackbar.showSnackbar(t)}).catch(function(e){console.log(e)})})}else{sendData()}});